<html>
  <head>
    <link rel="stylesheet" href="leaflet.css" />
    <link rel="stylesheet" href="PruneCluster.css" />
    <link rel="stylesheet" href="nouislider.min.css" />
    <link rel="stylesheet" href="main.css" />
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="leaflet.js"></script>
    <script src="PruneCluster.js"></script>
    <script src="nouislider.min.js"></script>
    <script src="wNumb.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-7927025-12', 'auto');
      ga('send', 'pageview');

    </script>
    <title>Houston Interactive Parking Ticket Map</title>
    <script>
      String.prototype.capitalizeFirstLetter = function() {
        return this.charAt(0).toUpperCase() + this.slice(1);
      }
      var pruneCluster = new PruneClusterForLeaflet();
      var markers = {};
      var DoW = ["Mon", "Tues", "Wed", "Thurs", "Fri", "Sat", "Sun"];
      $(function(){
        //Setup leaflet map
        var houstonmap = L.map('houstonmap').setView([29.7604, -95.3698], 12);
          L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="http://osm.org/copyright" target="_blank">OpenStreetMap</a> with <a href="https://github.com/SINTEF-9012/PruneCluster" target="_blank">PruneCluser</a>. More info about this <a href="http://data.houstontx.gov/dataset/city-of-houston-parking-citations">data</a> can be found in my <a href="https://github.com/jpoles1/HOUTix/blob/master/README.md">report (source, methodology)</a>'
        }).addTo(houstonmap);
        //Fetch json ticket data
        $.getJSON("violation_index.json", function(violations){
          violations = violations[0];
          for(violation in violations){
            violations[violation] = violations[violation].capitalizeFirstLetter();
            violation_name = violations[violation]
            $("#violation-list").append("<input type='checkbox' value="+violation+">"+violation_name+"</input><br>");
          }
          $.getJSON("ticket_coords.json", function(ticket_coords){
            //Create ticket dict and register markers with clustering plugin
            for(ticket_id in ticket_coords){
              var entry = ticket_coords[ticket_id];
              markers[ticket_id] = new PruneCluster.Marker(entry["lat"], entry["long"]);
              markers[ticket_id].timept = entry["time"].split(":")[0]
              markers[ticket_id].DoW = entry["DoW"]
              markers[ticket_id].filtered = false;
              markers[ticket_id].data.popup = DoW[entry["DoW"]-1]+" at "+entry["time"]+"<br>"+violations[entry["reason"]];
              pruneCluster.RegisterMarker(markers[ticket_id]);
            }
            //Add everything to the map
            houstonmap.addLayer(pruneCluster);
            pruneCluster.ProcessView();
          })
        });
        //Setup time-range slider
        var time_range = document.getElementById('timeslider');
        noUiSlider.create(time_range, {
        	start: [ 0, 24 ],
          range: { min: 0, max: 24 },
        	step: 1,
        	margin: 1,
        	connect: true,
        	direction: 'rtl',
        	orientation: 'vertical',
        	behaviour: 'tap-drag', // Move handle on tap, bar is draggable
        	pips: {
        		mode: 'steps',
            filter: function(){return 1;},
            format: wNumb({
        			postfix: ':00'
        		})
        	}
        });
        //Day of Week slidervar time_range = document.getElementById('timeslider');
        var dow_range = document.getElementById('dowslider');
        noUiSlider.create(dow_range, {
          start: [ 1, 7 ],
          range: { min: 1, max: 7 },
          step: 1,
          margin: 0,
          connect: true,
          direction: 'rtl',
          orientation: 'vertical',
          behaviour: 'tap-drag', // Move handle on tap, bar is draggable
          pips: {
            mode: 'steps',
            filter: function(){return 1;},
          }
        });
        //Rename DoW numbers to abbreviations
        $('#dowslider .noUi-value-vertical').each(function(){
          var val = $(this).html();
          val = DoW[parseInt(val)-1];
          $(this).html(val);
        });
        //Setup listener functions
        var time_low=0
        var time_high=24;
        var DoW_low = 1;
        var DoW_high = 7;
        filter_markers = function(){
          for(markerid in markers){
            var entity = markers[markerid];
            if(entity.timept >= time_low && entity.timept<= time_high && entity.DoW >= DoW_low && entity.DoW <= DoW_high){
              entity.filtered = false;
            }
            else{
              entity.filtered = true;
            }
          }
          pruneCluster.ProcessView();
        }
        time_range.noUiSlider.on('set', function(values){
          time_low = parseInt(values[0]);
          time_high = parseInt(values[1]);
          filter_markers();
        });
        dow_range.noUiSlider.on('set', function(values){
          console.log(values)
          DoW_low = parseInt(values[0]);
          DoW_high = parseInt(values[1]);
          filter_markers();
        });
      })
    </script>
  </head>
  <body>
    <div id="container">
      <h2>HOU Interactive Parking Ticket Map (# Tickets by Area)</h2>
      <div id="houstonmap"></div>
      <div id="timeslider" class="slider"><div class="slider-title">Filter by Time of Day:</div></div>
      <div id="dowslider" class="slider"><div class="slider-title">Filter by Day of Week:</div></div>
      <div id="violation-select">
        <h3>Filter on Violation:</h3>
        <form id="violation-list">

        </form>
      </div>
    </div>
  </body>
</html>
